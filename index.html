<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Cheap Talk</title>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/d3@7"></script>
        <style type="text/css">
			.line {
				fill: none;
				stroke-width: 2;
			}
            label {
                font-weight: bold;
            }
		</style>
    </head>
</html>
<body>
    <label for="aSlider">a = </label>
    <label id="a-value">0.125</label>
    <input type="range" name="aSlider" id=aSlider min="-0.3" max="0.3" value="0.125" step="0.005" style="margin: 0; width: 600px;">
    <br>
    <script type="text/javascript">
        let w = 1700;
        let h = 1000;
        let padding = 50;
        
        let svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

        let bins = 1000;
        let aVal = 0.125;
        
        let uS = (y,m) => {
            return -((y-m)**2);
        }
        let uR = (y,m,a) => {
            return -((y-(m+a))**2);
        }
        let computeYSender = () => {
            let ySender = Array();
            for(let i = 0; i < bins; i++) {
                let mVal = i/bins;
                ySender.push({
                    mVal: mVal,
                    yVal: mVal
                })
            }
            return ySender;
        }
        let computeYReceiver = () => {
            let yReceiver = Array();
            for(let i = 0; i < bins; i++) {
                let mVal = i/bins;
                yReceiver.push({
                    mVal: mVal,
                    yVal: mVal + aVal
                })
            }
            return yReceiver;
        }
        let border = (p,i) => {
            if(i == 0){ return 0; }
            if(i == p){ return 1; }
            return (1/p + 2*aVal*p)*i - 2*aVal*(i**2);
        }
        let isValidPartition = (p) => {
            return (1/p - 2*Math.abs(aVal)*p + 2*Math.abs(aVal)) > 0;
        }
        let maxPartition = () => {
            return parseInt(1/2 + Math.sqrt((2+Math.abs(aVal))/(4*Math.abs(aVal))));
        }
        let totalUtility = (data, key) => {
            let res = 0;
            for(let i = 0; i < data.length; i++) {
                res = res + data[i][key];
            }
            return res/bins;
        }
        let computeSUtility = (p) => {
            if(p == 0){
                let data = Array();
                for(let j = 0; j < bins; j++){
                    data.push({
                        mVal: j/bins,
                        uSVal: 0
                    })
                }
                return data
            }
            let data = Array();
            let i = 1;
            let yVal = (border(p,i-1)+border(p,i))/2+aVal;
            let upper = border(p,i)
            for(let j = 0; j < bins; j++){
                if(j/bins > upper){
                    i = i + 1;
                    yVal = (border(p,i-1)+border(p,i))/2+aVal;
                    upper = border(p,i);
                }
                let mVal = j/bins;
                data.push({
                    mVal: mVal,
                    uSVal: uS(yVal,mVal)
                })
            }
            return data;
        }

        let computeRUtility = (p) => {
            if(p == 0){
                let data = Array();
                for(let j = 0; j < bins; j++){
                    data.push({
                        mVal: j/bins,
                        uRVal: 0
                    })
                }
                return data
            }
            let data = Array();
            let i = 1;
            let yVal = (border(p,i-1)+border(p,i))/2+aVal;
            let upper = border(p,i)
            for(let j = 0; j < bins; j++){
                if(j/bins > upper){
                    i = i + 1;
                    yVal = (border(p,i-1)+border(p,i))/2+aVal;
                    upper = border(p,i);
                }
                let mVal = j/bins;
                data.push({
                    mVal: mVal,
                    uRVal: uR(yVal,mVal,aVal)
                })
            }
            return data;
        }

        svg.append("text")
            .attr("x", 350 / 2)             
            .attr("y", padding - 10)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Babbling");
        svg.append("text")
            .attr("x", 350 / 2 + 350)             
            .attr("y", padding - 10)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Partition Equilibrium, p = 2");
        svg.append("text")
            .attr("id", "largest-p")
            .attr("x", 350 / 2 + 350 * 2)             
            .attr("y", padding - 10)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Largest Partition Size, p = " + (aVal == 0 ? "infinity" : maxPartition()));

        svg.append("text")
            .attr("x", 350 / 2)             
            .attr("y", 300 - padding + 40)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Type (m)");
        svg.append("text")
            .attr("x", 350 / 2 + 350)             
            .attr("y", 300 - padding + 40)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Type (m)");
        svg.append("text")
            .attr("x", 350 / 2 + 350*2)             
            .attr("y", 300 - padding + 40)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Type (m)");
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", - 300 / 2)             
            .attr("y", padding-35)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Action (y)");
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", - 300 / 2 - 300)             
            .attr("y", padding-35)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Sender's Expected Utility");
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", - 300 / 2 - 300*2)             
            .attr("y", padding-35)
            .attr("text-anchor", "middle") 
            .style("font-size", "18px")
            .text("Receiver's Expected Utility");

        
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10)
            .style("font-size", "18px")
            .text("Key ideas:")
            .attr("font-weight", "bold")
            .attr("text-anchor", "start");
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10 + 25)
            .style("font-size", "18px")
            .text("1. Larger |a| = larger difference in preferences (|a| = 0 means identical preferences)")
            .attr("text-anchor", "start");
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10 + 25*2)
            .style("font-size", "18px")
            .text("2. Always exists a babbling equilibrium")
            .attr("text-anchor", "start");
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10 + 25*3)
            .style("font-size", "18px")
            .text("3. Largest partition size increases as |a| decreases")
            .attr("text-anchor", "start");
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10 + 25*4)
            .style("font-size", "18px")
            .text("4. Expected utilities increase as partition size increase")
            .attr("text-anchor", "start");
        svg.append("text")
            .attr("x", 350*3 + padding)             
            .attr("y", 300 + padding - 10 + 25*5)
            .style("font-size", "18px")
            .text("5. Expected utilities increase as |a| decreases")
            .attr("text-anchor", "start");

        svg.append("line")
            .attr("x1", 350*3 + padding)
            .attr("x2", 350*3 + padding + 40)
            .attr("y1", padding + 20)
            .attr("y2", padding + 20)
            .attr("stroke-width", 10)
            .attr("stroke-opacity", 0.3)
            .attr("stroke", "#1F77B4")
        svg.append("text")
            .attr("x", 350*3 + padding + 50)             
            .attr("y", padding + 20)
            .attr("dy", "0.3em")
            .style("font-size", "18px")
            .text("Action Sender ideally wants")
            .attr("text-anchor", "start");
        svg.append("line")
            .attr("x1", 350*3 + padding)
            .attr("x2", 350*3 + padding + 40)
            .attr("y1", padding + 50)
            .attr("y2", padding + 50)
            .attr("stroke-width", 10)
            .attr("stroke-opacity", 0.3)
            .attr("stroke", "#FF7F0E")
        svg.append("text")
            .attr("x", 350*3 + padding + 50)             
            .attr("y", padding + 50)
            .attr("dy", "0.3em")
            .style("font-size", "18px")
            .text("Action Receiver ideally wants")
            .attr("text-anchor", "start");
        svg.append("line")
            .attr("x1", 350*3 + padding)
            .attr("x2", 350*3 + padding + 40)
            .attr("y1", padding + 100)
            .attr("y2", padding + 100)
            .attr("stroke-width", 10)
            .attr("stroke", "#756BB1")
            .attr("stroke-dasharray", [10,5]);
        svg.append("text")
            .attr("x", 350*3 + padding + 50)             
            .attr("y", padding + 100)
            .attr("dy", "0.3em")
            .style("font-size", "18px")
            .text("Sender's Partition")
            .attr("text-anchor", "start");
        svg.append("line")
            .attr("x1", 350*3 + padding)
            .attr("x2", 350*3 + padding + 40)
            .attr("y1", padding + 130)
            .attr("y2", padding + 130)
            .attr("stroke-width", 10)
            .attr("stroke", "#D62728");
        svg.append("text")
            .attr("x", 350*3 + padding + 50)             
            .attr("y", padding + 130)
            .attr("dy", "0.3em")
            .style("font-size", "18px")
            .text("Receiver's Action")
            .attr("text-anchor", "start");

        let xScale = Array();
        let yScale = Array();
        let xAxis = Array();
        let yAxis = Array();
        for(let i = 0; i < 3; i++) {
            xScale.push(d3.scaleLinear()
                            .domain([0, 1])
                            .range([350*i+padding, 350*i+350-padding]))
            yScale.push(d3.scaleLinear()
                            .domain([-0.3, 1.3])
                            .range([300-padding, padding]))
            xAxis.push(d3.axisBottom()
                            .scale(xScale[i])
                            .ticks(5));
            yAxis.push(d3.axisLeft()
                            .scale(yScale[i])
                            .ticks(5));
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (300 - padding) + ")")
                .call(xAxis[i]);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (350*i+padding) + ",0)")
                .call(yAxis[i]);
            svg.append("path")
                .datum(computeYSender())
                .attr("class", "line")
                .attr("d", d3.line()
                    .x((d)=> { return xScale[i](d.mVal); })
                    .y((d)=> { return yScale[i](d.yVal); })
                )
                .attr("stroke-opacity", 0.3)
                .attr("stroke", "#1F77B4");
            svg.append("path")
                .attr("id", "yReceiver" + i)
                .datum(computeYReceiver())
                .attr("class", "line")
                .attr("d", d3.line()
                    .x((d)=> { return xScale[i](d.mVal); })
                    .y((d)=> { return yScale[i](d.yVal); })
                )
                .attr("stroke-opacity", 0.3)
                .attr("stroke", "#FF7F0E");
            if(i == 0 || i == 2) {
                svg.append("line")
                    .attr("x1", xScale[i](1))
                    .attr("x2", xScale[i](1))
                    .attr("y1", yScale[i](-0.3))
                    .attr("y2", yScale[i](1.3))
                    .attr("stroke", "#756BB1")
                    .attr("stroke-width", 3)
                    .attr("stroke-dasharray", [3,5]);
            }
            if(i == 0) {
                svg.append("line")
                    .attr("id", "p1y1")
                    .attr("x1", xScale[i](0))
                    .attr("x2", xScale[i](1))
                    .attr("y1", yScale[i](0.5+aVal))
                    .attr("y2", yScale[i](0.5+aVal))
                    .attr("stroke-width", 4)
                    .attr("stroke", "#D62728");
            } else if(i == 1){
                svg.append("line")
                    .attr("id", "p2m1")
                    .attr("x1", xScale[i](border(2,1)))
                    .attr("x2", xScale[i](border(2,1)))
                    .attr("y1", yScale[i](-0.3))
                    .attr("y2", yScale[i](1.3))
                    .attr("stroke-width", 3)
                    .attr("stroke", "#756BB1")
                    .attr("stroke-dasharray", [3,5]);
                svg.append("line")
                    .attr("id", "p2m2")
                    .attr("x1", xScale[i](1))
                    .attr("x2", xScale[i](1))
                    .attr("y1", yScale[i](-0.3))
                    .attr("y2", yScale[i](1.3))
                    .attr("stroke-width", 3)
                    .attr("stroke", "#756BB1")
                    .attr("stroke-dasharray", [3,5]);
                svg.append("line")
                    .attr("id", "p2y1")
                    .attr("x1", xScale[i](0))
                    .attr("x2", xScale[i](border(2,1)))
                    .attr("y1", yScale[i](border(2,1)/2+aVal))
                    .attr("y2", yScale[i](border(2,1)/2+aVal))
                    .attr("stroke-width", 4)
                    .attr("stroke", "#D62728");
                svg.append("line")
                    .attr("id", "p2y2")
                    .attr("x1", xScale[i](border(2,1)))
                    .attr("x2", xScale[i](1))
                    .attr("y1", yScale[i](border(2,1)/2+0.5+aVal))
                    .attr("y2", yScale[i](border(2,1)/2+0.5+aVal))
                    .attr("stroke-width", 4)
                    .attr("stroke", "#D62728");
            } else if (i == 2){
                for(let j = 1; j < 50; j++) {
                    svg.append("line")
                        .attr("id", "pm" + j)
                        .attr("x1", xScale[i](0))
                        .attr("x2", xScale[i](0))
                        .attr("y1", yScale[i](-0.3))
                        .attr("y2", yScale[i](1.3))
                        .attr("stroke-width", 3)
                        .attr("stroke-opacity", 0)
                        .attr("stroke", "#756BB1")
                        .attr("stroke-dasharray", [3,5]);
                }
                for(let j = 1; j <= 50; j++) {
                    svg.append("line")
                        .attr("id", "py" + j)
                        .attr("x1", xScale[i](0))
                        .attr("x2", xScale[i](1))
                        .attr("y1", yScale[i](-0.3))
                        .attr("y2", yScale[i](-0.3))
                        .attr("stroke-width", 4)
                        .attr("stroke-opacity", 0)
                        .attr("stroke", "#D62728");
                }
            }
        }
        for(let i = 0; i < 3; i++) {
            xScale.push(d3.scaleLinear()
                            .domain([0, 1])
                            .range([350*i+padding, 350*i+350-padding]))
            yScale.push(d3.scaleLinear()
                            .domain([-0.7, 0])
                            .range([300+300-padding, 300+padding]))
            xAxis.push(d3.axisBottom()
                            .scale(xScale[i+3])
                            .ticks(5));
            yAxis.push(d3.axisLeft()
                            .scale(yScale[i+3])
                            .ticks(5));
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (300 + 300 - padding) + ")")
                .call(xAxis[i+3]);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (350*i+padding) + ",0)")
                .call(yAxis[i+3]);
            if(i == 0) {
                let sUtility = computeSUtility(1)
				svg.append("path")
                    .attr("id","babble-sender")
					.datum(sUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("stroke", "#756BB1");
                svg.append("path")
                    .attr("id","babble-sender-area")
					.datum(sUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y0((d)=> { return yScale[i+3](-0.7); })
                                .y1((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("fill", "#756BB1")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "babble-sender-text")
                    .attr("x", 350 / 2)             
                    .attr("y", 300 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")));
            } else if(i == 1) {
                let sUtility = computeSUtility(2)
				svg.append("path")
                    .attr("id","p2-sender")
					.datum(sUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("stroke", "#756BB1");
                svg.append("path")
                    .attr("id","p2-sender-area")
					.datum(sUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y0((d)=> { return yScale[i+3](-0.7); })
                                .y1((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("fill", "#756BB1")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "p2-sender-text")
                    .attr("x", 350 + 350 / 2)             
                    .attr("y", 300 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")));
            } else if(i == 2) {
                let sUtility = computeSUtility(2)
				svg.append("path")
                    .attr("id","p-sender")
					.datum(sUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("stroke", "#756BB1");
                svg.append("path")
                    .attr("id","p-sender-area")
					.datum(sUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+3](d.mVal); })
                                .y0((d)=> { return yScale[i+3](-0.7); })
                                .y1((d)=> { return yScale[i+3](d.uSVal); }))
                    .attr("fill", "#756BB1")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "p-sender-text")
                    .attr("x", 350*2 + 350 / 2)             
                    .attr("y", 300 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")));
            }
        }

        for(let i = 0; i < 3; i++) {
            xScale.push(d3.scaleLinear()
                            .domain([0, 1])
                            .range([350*i+padding, 350*i+350-padding]))
            yScale.push(d3.scaleLinear()
                            .domain([-0.7, 0]) // TODO
                            .range([300*2+300-padding, 300+300+padding]))
            xAxis.push(d3.axisBottom()
                            .scale(xScale[i+6])
                            .ticks(5));
            yAxis.push(d3.axisLeft()
                            .scale(yScale[i+6])
                            .ticks(5));
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (300*2 + 300 - padding) + ")")
                .call(xAxis[i+6]);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (350*i+padding) + ",0)")
                .call(yAxis[i+6]);
            if(i == 0) {
                let rUtility = computeRUtility(1)
				svg.append("path")
                    .attr("id","babble-receiver")
					.datum(rUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("stroke", "#D62728");
                svg.append("path")
                    .attr("id","babble-receiver-area")
					.datum(rUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y0((d)=> { return yScale[i+6](-0.7); })
                                .y1((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("fill", "#D62728")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "babble-receiver-text")
                    .attr("x", 350 / 2)             
                    .attr("y", 300*2 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")));
            } else if(i == 1) {
                let rUtility = computeRUtility(2)
				svg.append("path")
                    .attr("id","p2-receiver")
					.datum(rUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("stroke", "#D62728");
                svg.append("path")
                    .attr("id","p2-receiver-area")
					.datum(rUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y0((d)=> { return yScale[i+6](-0.7); })
                                .y1((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("fill", "#D62728")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "p2-receiver-text")
                    .attr("x", 350 + 350 / 2)             
                    .attr("y", 300*2 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")));
            } else if(i == 2) {
                let rUtility = computeRUtility(2)
				svg.append("path")
                    .attr("id","p-receiver")
					.datum(rUtility)
					.attr("class", "line")
					.attr("d", d3.line()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("stroke", "#D62728");
                svg.append("path")
                    .attr("id","p-receiver-area")
					.datum(rUtility)
					.attr("d", d3.area()
                                .x((d)=> { return xScale[i+6](d.mVal); })
                                .y0((d)=> { return yScale[i+6](-0.7); })
                                .y1((d)=> { return yScale[i+6](d.uRVal); }))
                    .attr("fill", "#D62728")
                    .attr("fill-opacity", 0.3)
                svg.append("text")
                    .attr("id", "p-receiver-text")
                    .attr("x", 350*2 + 350 / 2)             
                    .attr("y", 300*2 + padding - 10)
                    .attr("text-anchor", "middle") 
                    .style("font-size", "18px")
                    .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")));
            }
        }

        let updateAVal = () => {
            for(let i = 0; i < 3; i++) {
                svg.select("#yReceiver" + i)
                    .datum(computeYReceiver())
                    .transition()
                    .duration(500)
                    .attr("d", d3.line()
                        .x((d)=> { return xScale[i](d.mVal); })
                        .y((d)=> { return yScale[i](d.yVal); })
                    )
            }
            let sUtility = computeSUtility(1)
            svg.select("#babble-sender")
                .datum(sUtility)
                .transition()
                .duration(500)
                .attr("d", d3.line()
                            .x((d)=> { return xScale[3](d.mVal); })
                            .y((d)=> { return yScale[3](d.uSVal); }))
            svg.select("#babble-sender-area")
                .datum(sUtility)
                .transition()
                .duration(500)
                .attr("d", d3.area()
                            .x((d)=> { return xScale[3](d.mVal); })
                            .y0((d)=> { return yScale[3](-0.7); })
                            .y1((d)=> { return yScale[3](d.uSVal); }))
            svg.select("#babble-sender-text")
                .transition()
                .duration(500)
                .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")))
            svg.select("#p1y1")
                .transition()
                .duration(500)
                .attr("x1", xScale[0](0))
                .attr("x2", xScale[0](1))
                .attr("y1", yScale[0](0.5+aVal))
                .attr("y2", yScale[0](0.5+aVal))
                .attr("stroke-opacity", 1)
            let rUtility = computeRUtility(1)
            svg.select("#babble-receiver")
                .datum(rUtility)
                .transition()
                .duration(500)
                .attr("d", d3.line()
                            .x((d)=> { return xScale[6](d.mVal); })
                            .y((d)=> { return yScale[6](d.uRVal); }))
            svg.select("#babble-receiver-area")
                .datum(rUtility)
                .transition()
                .duration(500)
                .attr("d", d3.area()
                            .x((d)=> { return xScale[6](d.mVal); })
                            .y0((d)=> { return yScale[6](-0.7); })
                            .y1((d)=> { return yScale[6](d.uRVal); }))
            svg.select("#babble-receiver-text")
                .transition()
                .duration(500)
                .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")))
            svg.select("#p1y1")
                .transition()
                .duration(500)
                .attr("x1", xScale[0](0))
                .attr("x2", xScale[0](1))
                .attr("y1", yScale[0](0.5+aVal))
                .attr("y2", yScale[0](0.5+aVal))
                .attr("stroke-opacity", 1)
            if(isValidPartition(2)){
                let sUtility = computeSUtility(2)
                svg.select("#p2-sender")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("d", d3.line()
                                .x((d)=> { return xScale[4](d.mVal); })
                                .y((d)=> { return yScale[4](d.uSVal); }))
                    .attr("stroke-opacity", 1)
                svg.select("#p2-sender-area")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("d", d3.area()
                                .x((d)=> { return xScale[4](d.mVal); })
                                .y0((d)=> { return yScale[4](-0.7); })
                                .y1((d)=> { return yScale[4](d.uSVal); }))
                    .attr("fill-opacity", 0.3)
                svg.select("#p2-sender-text")
                    .transition()
                    .duration(500)
                    .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")))
                    .attr("fill-opacity", 1)
                let rUtility = computeRUtility(2)
                svg.select("#p2-receiver")
                    .datum(rUtility)
                    .transition()
                    .duration(500)
                    .attr("d", d3.line()
                                .x((d)=> { return xScale[7](d.mVal); })
                                .y((d)=> { return yScale[7](d.uRVal); }))
                    .attr("stroke-opacity", 1)
                svg.select("#p2-receiver-area")
                    .datum(rUtility)
                    .transition()
                    .duration(500)
                    .attr("d", d3.area()
                                .x((d)=> { return xScale[7](d.mVal); })
                                .y0((d)=> { return yScale[7](-0.7); })
                                .y1((d)=> { return yScale[7](d.uRVal); }))
                    .attr("fill-opacity", 0.3)
                svg.select("#p2-receiver-text")
                    .transition()
                    .duration(500)
                    .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")))
                    .attr("fill-opacity", 1)
                svg.select("#p2m1")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](border(2,1)))
                    .attr("x2", xScale[1](border(2,1)))
                    .attr("stroke-opacity", 1)
                svg.select("#p2m2")
                    .transition()
                    .attr("x1", xScale[1](1))
                    .attr("x2", xScale[1](1))
                    .duration(500)
                    .attr("stroke-opacity", 1)
                svg.select("#p2y1")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](0))
                    .attr("x2", xScale[1](border(2,1)))
                    .attr("y1", yScale[1](border(2,1)/2+aVal))
                    .attr("y2", yScale[1](border(2,1)/2+aVal))
                    .attr("stroke-opacity", 1)
                svg.select("#p2y2")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](border(2,1)))
                    .attr("x2", xScale[1](1))
                    .attr("y1", yScale[1](border(2,1)/2+0.5+aVal))
                    .attr("y2", yScale[1](border(2,1)/2+0.5+aVal))
                    .attr("stroke-opacity", 1)
            } else {
                console.log("here")
                svg.select("#p2-sender")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("stroke-opacity", 0)
                svg.select("#p2-sender-area")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("fill-opacity", 0)
                svg.select("#p2-sender-text")
                    .transition()
                    .duration(500)
                    .attr("fill-opacity", 0)
                svg.select("#p2-receiver")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("stroke-opacity", 0)
                svg.select("#p2-receiver-area")
                    .datum(sUtility)
                    .transition()
                    .duration(500)
                    .attr("fill-opacity", 0)
                svg.select("#p2-receiver-text")
                    .transition()
                    .duration(500)
                    .attr("fill-opacity", 0)
                svg.select("#p2m1")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](1))
                    .attr("x2", xScale[1](1))
                    .attr("stroke-opacity", 0)
                svg.select("#p2m2")
                    .transition()
                    .duration(500)
                    .attr("stroke-opacity", 0)
                svg.select("#p2y1")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](0))
                    .attr("x2", xScale[1](1))
                    .attr("y1", yScale[1](-0.3))
                    .attr("y2", yScale[1](-0.3))
                    .attr("stroke-opacity", 0)
                svg.select("#p2y2")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[1](0))
                    .attr("x2", xScale[1](1))
                    .attr("y1", yScale[1](-0.3))
                    .attr("y2", yScale[1](-0.3))
                    .attr("stroke-opacity", 0)
            }
            let p = maxPartition();
            sUtility = aVal == 0 ? computeSUtility(0) : computeSUtility(p)
            svg.select("#p-sender")
                .datum(sUtility)
                .transition()
                .duration(500)
                .attr("d", d3.line()
                            .x((d)=> { return xScale[5](d.mVal); })
                            .y((d)=> { return yScale[5](d.uSVal); }))
            svg.select("#p-sender-area")
                .datum(sUtility)
                .transition()
                .duration(500)
                .attr("d", d3.area()
                            .x((d)=> { return xScale[5](d.mVal); })
                            .y0((d)=> { return yScale[5](-0.7); })
                            .y1((d)=> { return yScale[5](d.uSVal); }))
            svg.select("#p-sender-text")
                .transition()
                .duration(500)
                .text("E[US] = " + d3.format('.5')(totalUtility(sUtility, "uSVal")))
            rUtility = aVal == 0 ? computeRUtility(0) : computeRUtility(p);
            console.log(rUtility)
            svg.select("#p-receiver")
                .datum(rUtility)
                .transition()
                .duration(500)
                .attr("d", d3.line()
                            .x((d)=> { return xScale[8](d.mVal); })
                            .y((d)=> { return yScale[8](d.uRVal); }))
            svg.select("#p-receiver-area")
                .datum(rUtility)
                .transition()
                .duration(500)
                .attr("d", d3.area()
                            .x((d)=> { return xScale[8](d.mVal); })
                            .y0((d)=> { return yScale[8](-0.7); })
                            .y1((d)=> { return yScale[8](d.uRVal); }))
            svg.select("#p-receiver-text")
                .transition()
                .duration(500)
                .text("E[UR] = " + d3.format('.5')(totalUtility(rUtility, "uRVal")))
            if(aVal != 0) {
                for(i = 1; i <= p; i++){
                    svg.select("#pm" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](border(p,i)))
                        .attr("x2", xScale[2](border(p,i)))
                        .attr("stroke-opacity", 1)
                }
                for(i = p + 1; i < 50; i++){
                    svg.select("#pm" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](1))
                        .attr("x2", xScale[2](1))
                        .attr("stroke-opacity", 0)
                }
                for(i = 1; i <= p; i++){
                    svg.select("#py" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](border(p,i-1)))
                        .attr("x2", xScale[2](border(p,i)))
                        .attr("y1", yScale[2]((border(p,i-1)+border(p,i))/2+aVal))
                        .attr("y2", yScale[2]((border(p,i-1)+border(p,i))/2+aVal))
                        .attr("stroke-opacity", 1)
                }
                for(i = p + 1; i <= 50; i++){
                    svg.select("#py" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](0))
                        .attr("x2", xScale[2](1))
                        .attr("y1", yScale[2](-0.3))
                        .attr("y2", yScale[2](-0.3))
                        .attr("stroke-opacity", 0)
                }
            } else {
                for(i = 1; i <= 50; i++){
                    svg.select("#pm" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](i/50))
                        .attr("x2", xScale[2](i/50))
                        .attr("stroke-opacity", 1)
                }
                svg.select("#py1")
                    .transition()
                    .duration(500)
                    .attr("x1", xScale[2](0))
                    .attr("x2", xScale[2](1))
                    .attr("y1", yScale[2](aVal))
                    .attr("y2", yScale[2](1+aVal))
                    .attr("stroke-opacity", 1)
                for(i = 2; i <= 50; i++){
                    svg.select("#py" + i)
                        .transition()
                        .duration(500)
                        .attr("x1", xScale[2](0))
                        .attr("x2", xScale[2](1))
                        .attr("y1", yScale[2](-0.3))
                        .attr("y2", yScale[2](-0.3))
                        .attr("stroke-opacity", 0)
                }
            }
            svg.select("#largest-p")
                .transition()
                .duration(500)
                .text("Largest Partition, p = " + (aVal == 0 ? "infinity" : maxPartition()))
        }

        d3.select("#aSlider").on("change", function(d){
            aVal = parseFloat(this.value);
            d3.select('#a-value').text(d3.format('.3')(aVal));
            updateAVal();
        })
        updateAVal();
    </script>
</body>
